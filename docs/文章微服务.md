# 1.文章微服务
## a) App文章加载接口定义：
|          | **加载首页**         | **加载更多**             | **加载最新**            |
| -------- | -------------------- | ------------------------ | ----------------------- |
| 接口路径 | /api/v1/article/load | /api/v1/article/loadmore | /api/v1/article/loadnew |
| 请求方式 | POST                 | POST                     | POST                    |
| 参数     | ArticleHomeDto       | ArticleHomeDto           | ArticleHomeDto          |
| 响应结果 | ResponseResult       | ResponseResult           | ResponseResult          |
## b) 文章模版引擎：freemarker：
* FreeMarker 是一款 模板引擎： 即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。

![](/resources/freemarker.png)

## c) 对象存储服务MinIO：
MinIO基于Apache License v2.0开源协议的对象存储服务，可以做为云存储的解决方案用来保存海量的图片，视频，文档。由于采用Golang实现，服务端可以工作在Windows,Linux, OS X和FreeBSD上。配置简单，基本是复制可执行程序，单行命令可以运行起来。

* MinIO管理控制台：
![](/resources/MinIO.png)

* MinIO测试用例：

```java
public static void main(String[] args) {
        try {
            FileInputStream fileInputStream = new FileInputStream("文件路径");
            MinioClient minioClient = MinioClient.builder().credentials("用户名", "密码")
                    .endpoint("MinIO访问url").build();

            PutObjectArgs putObjectArgs = PutObjectArgs.builder()
                    .object("目标目录")
                    .contentType("文件类型")
                    .bucket("桶名")
                    .stream(fileInputStream, fileInputStream.available(), -1).build();
            minioClient.putObject(putObjectArgs);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
```

# 2.自媒体文章上下架：
* kafka实现自媒体微服务与文章微服务上下架功能系统解耦。

## 上下架流程说明：
![](/resources/上下架.png)

# 3.内容搜索：
- (1)文章搜索

  - ElasticSearch环境搭建

  - 索引库创建

  - 文章搜索多条件复合查询

  - 索引数据同步

- (2)搜索历史记录

  - Mongodb环境搭建

  - 异步保存搜索历史

  - 查看搜索历史列表

  - 删除搜索历史

- (3)联想词查询

  - 联想词的来源

  - 联想词功能实现

## a) 搭建ElasticSearch环境
* 拉取镜像

```shell
docker pull elasticsearch:7.4.0
```

* 创建容器

```shell
docker run -id --name elasticsearch -d --restart=always -p 9200:9200 -p 9300:9300 -v /usr/share/elasticsearch/plugins:/usr/share/elasticsearch/plugins -e "discovery.type=single-node" elasticsearch:7.4.0
```

* 配置中文分词器 ik

```shell
#Switch directory
cd /usr/share/elasticsearch/plugins
#New directory
mkdir analysis-ik
cd analysis-ik
#root Copies files to the root directory
mv elasticsearch-analysis-ik-7.4.0.zip /usr/share/elasticsearch/plugins/analysis-ik
#decompressing files
cd /usr/share/elasticsearch/plugins/analysis-ik
unzip elasticsearch-analysis-ik-7.4.0.zip
```

* [SpringBoot操作ElasticSearch](elasticsearch.md)

## b) app端文章搜索
- 用户输入关键词，可以搜索文章列表

- 关键词高亮显示

- 文章列表展示与home展示一样，当用户点击某一篇文章，可查看文章详情

### 1) 创建索引和映射
- 使用postman添加映射
    - put请求 ： http://192.168.31.125:9200/app_info_article
    - GET请求查询映射：http://192.168.31.125:9200/app_info_article
    - DELETE请求，删除索引及映射：http://192.168.31.125:9200/app_info_article
    - GET请求，查询所有文档：http://192.168.31.125:9200/app_info_article/_search

### 2) 数据初始化到索引库
```java
package com.heima.es;

import com.alibaba.fastjson.JSON;
import com.heima.es.mapper.ApArticleMapper;
import com.heima.es.pojo.SearchArticleVo;
import org.elasticsearch.action.bulk.BulkRequest;
import org.elasticsearch.action.index.IndexRequest;
import org.elasticsearch.client.RequestOptions;
import org.elasticsearch.client.RestHighLevelClient;
import org.elasticsearch.common.xcontent.XContentType;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.List;


@SpringBootTest
@RunWith(SpringRunner.class)
public class ApArticleTest {

    @Autowired
    private ApArticleMapper apArticleMapper;

    @Autowired
    private RestHighLevelClient restHighLevelClient;


    /**
     * 注意：数据量的导入，如果数据量过大，需要分页导入
     * @throws Exception
     */
    @Test
    public void init() throws Exception {

        //1.查询所有符合条件的文章数据
        List<SearchArticleVo> searchArticleVos = apArticleMapper.loadArticleList();

        //2.批量导入到es索引库

        BulkRequest bulkRequest = new BulkRequest("app_info_article");

        for (SearchArticleVo searchArticleVo : searchArticleVos) {

            IndexRequest indexRequest = new IndexRequest().id(searchArticleVo.getId().toString())
                    .source(JSON.toJSONString(searchArticleVo), XContentType.JSON);

            //批量添加数据
            bulkRequest.add(indexRequest);

        }
        restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);

    }

}
```

### 3) 测试
- postman查询所有的es中数据 GET请求： http://192.168.31.125:9200/app_info_article/_search

### 4) 文章自动审核构建索引
![](/resources/自动构建索引.png)

* 文章微服务的ArticleFreemarkerService中的buildArticleToMinIO方法中收集数据并发送消息。

### 5) app端搜索-搜索记录
- 展示用户的搜索记录10条，按照搜索关键词的时间倒序
- 可以删除搜索记录
- 保存历史记录，保存10条，多余的则删除最久的历史记录

#### a) 安装mongoDb
- 拉取镜像

```shell
docker pull mongo
```

- 创建容器

```shell
docker run -di --name mongo-service --restart=always -p 27017:27017 -v ~/data/mongodata:/data mongo
```

- 在ArticleSearchService的search方法中异步调用apUserSearchService.insert保存历史记录

* [spring 操作 mongodb](spring_mongodb.md)

#### b) 加载搜索记录列表
- 按照当前用户，按照时间倒序查询
|          | **说明**             |
| -------- | -------------------- |
| 接口路径 | /api/v1/history/load |
| 请求方式 | POST                 |
| 参数     | 无                   |
| 响应结果 | ResponseResult       |

#### c) 删除搜索记录
- 按照搜索历史id删除
|          | **说明**            |
| -------- | ------------------- |
| 接口路径 | /api/v1/history/del |
| 请求方式 | POST                |
| 参数     | HistorySearchDto    |
| 响应结果 | ResponseResult      |

#### 6) 关键字联想
- 自己维护搜索词到mongoDB中的ap_associate_words表中
|          | **说明**                 |
| -------- | ------------------------ |
| 接口路径 | /api/v1/associate/search |
| 请求方式 | POST                     |
| 参数     | UserSearchDto            |
| 响应结果 | ResponseResult           |